---
import HeaderLink from './HeaderLink.astro';
import { Image } from 'astro:assets';
import Logo from '../assets/logo/ciq_white_blue.webp';
---

<header class="header" data-header>
	<nav class="nav" data-nav>
		<div class="left">
			<div class="internal-links">
				<HeaderLink href="/">Home</HeaderLink>
				<HeaderLink href="/panels">Panels</HeaderLink>
				<HeaderLink href="/schedule">Schedule</HeaderLink>
				<HeaderLink href="/contact">Contact</HeaderLink>
			</div>

			<button
				class="burger burger--inline"
				type="button"
				aria-label="Open menu"
				aria-expanded="false"
				aria-controls="mobile-menu"
				data-burger-inline
			>
				<span></span><span></span><span></span>
			</button>
		</div>

		<div class="brand">
			<a href="/" class="logo-link" aria-label="Home">
				<Image src={Logo} alt="CIQ" class="logo" />
			</a>
		</div>

		<div class="right desktop-right">
			<a href="/tickets" class="btn">Code of Conduct</a>

			<a href="https://x.com/CIQ_event" target="_blank" rel="noopener noreferrer" class="x-link">
				<span class="sr-only">Follow CiQ on X</span>
				<svg viewBox="0 0 1200 1227" aria-hidden="true" width="32" height="32">
					<path
						fill="currentColor"
						d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"
					/>
				</svg>
			</a>
		</div>
	</nav>

	<button
		class="burger burger--float"
		type="button"
		aria-label="Open menu"
		aria-expanded="false"
		aria-controls="mobile-menu"
		hidden
		data-burger-float
	>
		<span></span><span></span><span></span>
	</button>

	<div id="mobile-menu" class="mobile-menu" hidden data-menu>
		<HeaderLink href="/">Home</HeaderLink>
		<HeaderLink href="/panels">Panels</HeaderLink>
		<HeaderLink href="/schedule">Schedule</HeaderLink>
		<HeaderLink href="/contact">Contact</HeaderLink>

		<a href="/tickets" class="btn btn--mobile">Code of Conduct</a>

		<a
			href="https://x.com/CIQ_event"
			target="_blank"
			rel="noopener noreferrer"
			class="mobile-x"
			aria-label="Follow CiQ on X"
		>
			<svg viewBox="0 0 1200 1227" aria-hidden="true" width="20" height="20" class="x-icon">
				<path
					d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"
				/>
			</svg>
		</a>
	</div>

	<script>
		const header = document.querySelector('[data-header]');
		const menu = header?.querySelector('[data-menu]');
		const burgerInline = header?.querySelector('[data-burger-inline]');
		const burgerFloat = header?.querySelector('[data-burger-float]');

		const MOBILE_BP = 1000;
		const COMPACT_SCROLL_Y = 120;

		const mobileMq = window.matchMedia(`(max-width: ${MOBILE_BP}px)`);

		if (header && menu && burgerInline && burgerFloat) {
			const setExpanded = () => {
				const expanded = String(!menu.hasAttribute('hidden'));
				burgerInline.setAttribute('aria-expanded', expanded);
				burgerFloat.setAttribute('aria-expanded', expanded);
			};

			const closeMenu = () => {
				menu.setAttribute('hidden', '');
				setExpanded();
			};

			const toggleMenu = () => {
				menu.toggleAttribute('hidden');
				setExpanded();
			};

			const applyCompact = () => {
				const shouldCompact = !mobileMq.matches && window.scrollY > COMPACT_SCROLL_Y;
				header.classList.toggle('is-compact', shouldCompact);

				if (shouldCompact) {
					burgerFloat.removeAttribute('hidden');
					closeMenu();
				} else {
					burgerFloat.setAttribute('hidden', '');
				}
			};

			const syncForBreakpoint = () => {
				if (!mobileMq.matches) closeMenu();
				applyCompact();
			};

			burgerInline.addEventListener('click', (e) => {
				e.preventDefault();
				toggleMenu();
			});

			burgerFloat.addEventListener('click', (e) => {
				e.preventDefault();
				toggleMenu();
			});

			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape') closeMenu();
			});

			document.addEventListener('click', (e) => {
				const t = e.target;
				if (!(t instanceof Node)) return;
				if (!menu.hasAttribute('hidden') && !header.contains(t)) closeMenu();
			});

			window.addEventListener('scroll', applyCompact, { passive: true });
			mobileMq.addEventListener('change', syncForBreakpoint);

			setExpanded();
			syncForBreakpoint();
		}
	</script>
</header>

<style>
	.header {
		position: sticky;
		top: 0;
		z-index: 1000;
		margin: 0;
		padding: 0 1em;
		background: hsl(192, 100%, 15%);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		color: rgb(var(--white));
	}

	.nav {
		position: relative;
		display: flex;
		align-items: center;
		justify-content: space-between;
		min-height: 96px;
		transition: opacity 180ms ease, transform 180ms ease;
	}

	.brand {
		position: absolute;
		left: 50%;
		top: 50%;
		transform: translate(-50%, -50%);
		display: flex;
		align-items: center;
		pointer-events: none;
	}

	.logo-link {
		pointer-events: auto;
		display: flex;
		align-items: center;
		padding: 0;
		margin: 0;
		color: inherit;
		text-decoration: none;
	}

	.logo {
		display: block;
		height: 64px;
		width: auto;
	}

	.left {
		display: flex;
		align-items: center;
		flex: 1;               /* take all space to the left of logo */
		min-width: 0;
	}

	:root {
		--links-gap: 350px;
	}

	.internal-links {
		display: flex;
		align-items: center;
		justify-content: space-around;
		gap: 0;
		width: 100%;
		max-width: min(calc(50vw - 120px), var(--links-gap)); /* prevent overlap with centered logo */
	}

	.desktop-right {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		min-width: 0;
	}

	.btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 0.55rem 0.9rem;
		border-radius: 999px;
		background: rgb(var(--white));
		color: hsl(192, 100%, 15%);
		text-decoration: none;
		font-weight: 600;
		line-height: 1;
		border: 1px solid rgba(255, 255, 255, 0.25);
		white-space: nowrap;
	}

	.btn:hover {
		filter: brightness(0.95);
	}

	.x-link {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		color: rgb(var(--white));
		text-decoration: none;
		padding: 0.25rem;
		border-radius: 10px;
	}

	.burger {
		display: none;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		gap: 6px;
		width: 44px;
		height: 44px;
		border-radius: 12px;
		border: 1px solid rgba(255, 255, 255, 0.25);
		background: transparent;
		padding: 0;
		cursor: pointer;
	}

	.burger span {
		display: block;
		width: 22px;
		height: 2px;
		background: rgb(var(--white));
		border-radius: 999px;
	}

	.mobile-menu {
		position: absolute;
		left: 1em;
		right: 1em;
		top: 100%;
		background: hsl(192, 100%, 15%);
		border: 1px solid rgba(255, 255, 255, 0.15);
		border-radius: 14px;
		padding: 0.5rem;
		display: grid;
		gap: 0.25rem;
		z-index: 1010;
		margin-top: 0.5rem;
		justify-items: center;
		overflow: hidden;
	}

	.mobile-menu :global(a:not(.btn)) {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 100%;
		box-sizing: border-box;
		color: inherit;
		text-decoration: none;
		padding: 0.75rem 0.75rem;
		border-radius: 10px;
		text-align: center;
	}

	.mobile-menu :global(a:not(.btn):hover) {
		background: rgba(255, 255, 255, 0.08);
	}

	.btn--mobile {
		width: 100%;
		justify-content: center;
		padding: 0.75rem 0.9rem;
		border-radius: 12px;
		box-sizing: border-box;
		margin: 0;
	}

	.btn--mobile:hover {
		filter: brightness(0.95);
	}

	.x-icon path {
		fill: rgb(var(--white));
	}

	@media (max-width: 1000px) {
		.internal-links {
			display: none;
		}
		.desktop-right {
			display: none;
		}
		.burger--inline {
			display: inline-flex;
		}
	}

	[hidden] {
		display: none !important;
	}

	.header.is-compact {
		background: transparent;
		box-shadow: none;
		padding: 0;
	}

	.header.is-compact .nav {
		opacity: 0;
		transform: translateY(-8px);
		visibility: hidden;
	}

	.header.is-compact .burger--float {
		display: inline-flex;
		position: fixed;
		top: 14px;
		left: 14px;
		z-index: 1100;
		background: hsl(192, 100%, 15%);
		box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
	}

	.header.is-compact .mobile-menu {
		position: fixed;
		top: -2px;
		left: 4px;
		right: auto;
		width: min(320px, calc(100vw - 28px));
		z-index: 1090;
	}

	@media (prefers-reduced-motion: reduce) {
		.nav {
			transition: none;
		}
	}
</style>
