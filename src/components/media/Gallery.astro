---
// src/components/media/Gallery.astro
import { Image, type ImageMetadata } from "astro:assets";

type GalleryItem = {
  key: string; // filename key used to resolve the module
  alt: string;
  caption?: string;
};

type Props = {
  title?: string;
  modules: Record<string, ImageMetadata>;
  items?: GalleryItem[];
  columns?: 2 | 3 | 4;
};

const { title, modules, columns = 3 } = Astro.props as Props;

function fileKeyFromPath(path: string) {
  const p = path.split("/").pop() ?? path;
  return p;
}

const derivedItems: GalleryItem[] = Object.entries(modules)
  .map(([path]) => {
    const key = fileKeyFromPath(path);
    const base = key.replace(/\.[^.]+$/, "");
    const alt = base.replace(/[-_]+/g, " ").trim();
    return { key, alt };
  })
  .sort((a, b) => a.key.localeCompare(b.key));

const items = (Astro.props as Props).items ?? derivedItems;

const indexToModulePath = new Map<string, string>();
for (const [path] of Object.entries(modules)) {
  indexToModulePath.set(fileKeyFromPath(path), path);
}

function assertModule(key: string): ImageMetadata {
  const path = indexToModulePath.get(key);
  if (!path) throw new Error(`Gallery: could not resolve module for key="${key}"`);
  return modules[path];
}
---

<section class="gallery" aria-label={title ?? "Gallery"}>
  {title && <h2 class="gallery__title">{title}</h2>}

  <div class={`gallery__grid gallery__grid--c${columns}`}>
    {items.map((it, i) => {
      const meta = assertModule(it.key);
      return (
        <button
          type="button"
          class="gallery__thumb"
          data-gallery-open
          data-index={i}
          aria-label={`Open image ${i + 1} of ${items.length}`}
        >
          <Image
            src={meta}
            alt={it.alt}
            class="gallery__thumbImg"
            loading="lazy"
            decoding="async"
          />
        </button>
      );
    })}
  </div>

  <dialog class="gallery__dialog" data-gallery-dialog aria-label="Image viewer">
    <div class="gallery__dialogInner">
      <button type="button" class="gallery__close" data-gallery-close aria-label="Close">
        ✕
      </button>

      <button type="button" class="gallery__nav gallery__nav--prev" data-gallery-prev aria-label="Previous image">
        ‹
      </button>

      <figure class="gallery__figure">
        <img class="gallery__full" data-gallery-img alt="" loading="eager" decoding="async" />
        <figcaption class="gallery__caption" data-gallery-caption></figcaption>
      </figure>

      <button type="button" class="gallery__nav gallery__nav--next" data-gallery-next aria-label="Next image">
        ›
      </button>
    </div>
  </dialog>

  <script>
    (() => {
      const root = document.currentScript?.closest(".gallery");
      if (!root) return;

      const openButtons = Array.from(root.querySelectorAll("[data-gallery-open]"));
      const dialog = root.querySelector("[data-gallery-dialog]");
      if (!(dialog instanceof HTMLDialogElement)) return;

      const img = root.querySelector("[data-gallery-img]");
      const caption = root.querySelector("[data-gallery-caption]");
      const closeBtn = root.querySelector("[data-gallery-close]");
      const prevBtn = root.querySelector("[data-gallery-prev]");
      const nextBtn = root.querySelector("[data-gallery-next]");

      const items = openButtons.map((btn) => {
        const thumbImg = btn.querySelector("img");
        const alt = thumbImg?.getAttribute("alt") ?? "";
        // Astro Image renders to <img src="..."> in final HTML; grab it for full view.
        // Note: We use the rendered src as the full image source; this is optimized already.
        const src = thumbImg?.getAttribute("src") ?? "";
        return { src, alt };
      });

      let index = 0;

      const render = () => {
        const it = items[index];
        if (!it) return;
        if (img instanceof HTMLImageElement) {
          img.src = it.src;
          img.alt = it.alt;
        }
        if (caption instanceof HTMLElement) {
          caption.textContent = it.alt;
        }
      };

      const openAt = (i) => {
        index = (i + items.length) % items.length;
        render();
        if (!dialog.open) dialog.showModal();
        closeBtn?.focus?.();
      };

      const close = () => {
        if (dialog.open) dialog.close();
      };

      const prev = () => openAt(index - 1);
      const next = () => openAt(index + 1);

      openButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const i = Number(btn.getAttribute("data-index") ?? "0");
          openAt(i);
        });
      });

      closeBtn?.addEventListener("click", close);
      prevBtn?.addEventListener("click", prev);
      nextBtn?.addEventListener("click", next);

      dialog.addEventListener("click", (e) => {
        // backdrop click closes
        const rect = dialog.getBoundingClientRect();
        const inDialog =
          e.clientX >= rect.left &&
          e.clientX <= rect.right &&
          e.clientY >= rect.top &&
          e.clientY <= rect.bottom;
        if (!inDialog) close();
      });

      dialog.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          e.preventDefault();
          close();
        } else if (e.key === "ArrowLeft") {
          e.preventDefault();
          prev();
        } else if (e.key === "ArrowRight") {
          e.preventDefault();
          next();
        }
      });
    })();
  </script>
</section>

<style>
  .gallery {
    width: 100%;
  }

  .gallery__title {
    margin: 0 0 1rem 0;
    color: rgb(var(--white));
    font-size: 1.4rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .gallery__grid {
    display: grid;
    gap: 0.9rem;
  }
  .gallery__grid--c2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .gallery__grid--c3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  .gallery__grid--c4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }

  @media (max-width: 900px) {
    .gallery__grid--c4 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  }
  @media (max-width: 650px) {
    .gallery__grid--c3,
    .gallery__grid--c4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }

  .gallery__thumb {
    display: block;
    padding: 0;
    border: 0;
    background: none;
    cursor: pointer;
    border-radius: 14px;
    overflow: hidden;
    outline: none;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.08) inset;
  }
  .gallery__thumb:focus-visible {
    box-shadow: 0 0 0 2px rgba(255,255,255,0.32), 0 0 0 1px rgba(255,255,255,0.08) inset;
  }

  .gallery__thumbImg {
    width: 100%;
    height: 190px;
    object-fit: cover;
    display: block;
    transform: scale(1);
    transition: transform 160ms ease, filter 160ms ease;
  }
  .gallery__thumb:hover .gallery__thumbImg {
    transform: scale(1.03);
    filter: brightness(1.05);
  }

  .gallery__dialog {
    border: none;
    padding: 0;
    background: rgba(0,0,0,0.0);
    max-width: min(1100px, calc(100vw - 2rem));
  }
  .gallery__dialog::backdrop {
    background: rgba(0,0,0,0.72);
  }

  .gallery__dialogInner {
    position: relative;
    background: rgba(10, 14, 22, 0.92);
    border-radius: 18px;
    box-shadow: 0 20px 70px rgba(0,0,0,0.55);
    overflow: hidden;
    display: grid;
    grid-template-columns: 56px 1fr 56px;
    align-items: center;
  }

  .gallery__close {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 42px;
    height: 42px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.08);
    color: rgb(var(--white));
    cursor: pointer;
  }
  .gallery__close:hover {
    background: rgba(255,255,255,0.12);
  }

  .gallery__nav {
    height: 100%;
    border: 0;
    background: none;
    color: rgba(255,255,255,0.9);
    cursor: pointer;
    font-size: 2.3rem;
    line-height: 1;
    display: grid;
    place-items: center;
  }
  .gallery__nav:hover {
    background: rgba(255,255,255,0.06);
  }

  .gallery__figure {
    margin: 0;
    display: grid;
    grid-template-rows: 1fr auto;
    gap: 0;
  }

  .gallery__full {
    width: 100%;
    height: min(72vh, 720px);
    object-fit: contain;
    display: block;
    background: rgba(0,0,0,0.35);
  }

  .gallery__caption {
    padding: 0.9rem 1rem;
    color: rgba(255,255,255,0.86);
    font-size: 0.95rem;
    border-top: 1px solid rgba(255,255,255,0.10);
  }

  @media (max-width: 650px) {
    .gallery__dialogInner {
      grid-template-columns: 44px 1fr 44px;
    }
    .gallery__thumbImg { height: 160px; }
  }
</style>
