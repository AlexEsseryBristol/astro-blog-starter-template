---
// src/components/ui/BackLink.astro
type Props = {
  defaultHref: string;
  defaultLabel: string;

  fromParam?: string;    // default "from"
  fromValue?: string;    // e.g. "panels"
  alternateHref?: string;
  alternateLabel?: string;

  // NEW: optional second button shown only in alternate mode
  secondaryHref?: string;
  secondaryLabel?: string;
  secondaryClassName?: string;

  className?: string;
};

const {
  defaultHref,
  defaultLabel,
  fromParam = "from",
  fromValue = "",
  alternateHref = "",
  alternateLabel = "",
  className = "btn",

  secondaryHref = "",
  secondaryLabel = "",
  secondaryClassName = "btn",
} = Astro.props as Props;

const altKey = (fromValue || "").trim();

const altAttrs: Record<string, string> = {};
if (altKey && alternateHref) altAttrs[`data-back-${altKey}-href`] = alternateHref;
if (altKey && alternateLabel) altAttrs[`data-back-${altKey}-label`] = alternateLabel;

const hasSecondary = Boolean(secondaryHref && secondaryLabel);
---

<div data-back-wrap style="display:flex; gap:0.75rem; align-items:center; width:100%;">
  <a
    href={defaultHref}
    class={className}
    data-back
    data-back-default-href={defaultHref}
    data-back-default-label={defaultLabel}
    data-back-param={fromParam}
    data-back-key={altKey}
    data-back-has-secondary={hasSecondary ? "1" : "0"}
    {...altAttrs}
  >
    {defaultLabel}
  </a>
  <div aria-hidden="true" style="flex: 1 1 auto;"></div>
  {hasSecondary && (
    <a
      href={secondaryHref}
      class={secondaryClassName}
      data-back-secondary
      data-back-secondary-href={secondaryHref}
      data-back-secondary-label={secondaryLabel}
      hidden
      style="display:none;"
    >
      {secondaryLabel}
    </a>
  )}
</div>

<script is:inline>
  (() => {
    const script = document.currentScript;
    const wrap = script?.previousElementSibling;
    if (!(wrap instanceof HTMLElement) || !wrap.hasAttribute("data-back-wrap")) return;

    const primary = wrap.querySelector('[data-back]');
    if (!(primary instanceof HTMLAnchorElement)) return;

    const secondary = wrap.querySelector('[data-back-secondary]');

    const url = new URL(window.location.href);

    const paramName = primary.getAttribute("data-back-param") || "from";
    const key = primary.getAttribute("data-back-key") || "";
    const from = url.searchParams.get(paramName) || "";

    const defaultHref = primary.getAttribute("data-back-default-href") || primary.href;
    const defaultLabel = primary.getAttribute("data-back-default-label") || primary.textContent || "";

    const inAltMode = key && from === key;

    const hideSecondary = () => {
      if (secondary instanceof HTMLAnchorElement) {
        secondary.hidden = true;
        secondary.style.display = "none";
      }
    };

    const showSecondary = () => {
      if (secondary instanceof HTMLAnchorElement) {
        const sh = secondary.getAttribute("data-back-secondary-href") || secondary.href;
        const sl = secondary.getAttribute("data-back-secondary-label") || secondary.textContent || "";
        secondary.href = sh;
        secondary.textContent = sl;
        secondary.hidden = false;
        secondary.style.display = "";
      }
    };

    if (inAltMode) {
      const href = primary.getAttribute(`data-back-${key}-href`);
      const label = primary.getAttribute(`data-back-${key}-label`);
      if (href && label) {
        primary.href = href;
        primary.textContent = label;
      }
      showSecondary();
      return;
    }

    primary.href = defaultHref;
    primary.textContent = defaultLabel;
    hideSecondary();
  })();
</script>