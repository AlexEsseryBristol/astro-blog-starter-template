---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";

type GridItem = {
  key: string;
  name: string;
  alt?: string;
  url?: string;
  src: ImageMetadata;
};

type Props = {
  title?: string;
  ariaLabel?: string;
  items: GridItem[];
  itemHeight?: number;
  itemWidth?: number;
  maxLogoWidth?: number;
};

const {
  title,
  ariaLabel = title ?? "Sponsors",
  items,
  itemHeight = 120,
  itemWidth = 200,
  maxLogoWidth = 240,
} = Astro.props as Props;
---

{title && <h2>{title}</h2>}

<div 
  class="spon-grid" 
  data-sponsor-grid 
  aria-label={ariaLabel}
  style={`--item-height: ${itemHeight}px; --item-width: ${itemWidth}px; --max-logo-width: ${maxLogoWidth}px;`}
>
  {items.map((s) => (
    <div class="spon-item" data-sponsor-item-key={s.key}>
      {s.url ? (
        <a
          class="spon-link"
          href={s.url}
          target="_blank"
          rel="noopener noreferrer"
          title={s.name}
        >
          <Image
            src={s.src}
            alt={s.alt ?? `${s.name} logo`}
            class="spon-logo"
          />
        </a>
      ) : (
        <Image
          src={s.src}
          alt={s.alt ?? `${s.name} logo`}
          class="spon-logo"
        />
      )}
    </div>
  ))}
</div>

<script is:inline>
(() => {
  const grids = () => Array.from(document.querySelectorAll("[data-spon-grid]"));

  const clearBreaks = (grid) => {
    grid.querySelectorAll("[data-spon-break]").forEach(n => n.remove());
  };

  const countCols = (items) => {
    if (!items.length) return 1;
    const top = items[0].offsetTop;
    let c = 0;
    for (const el of items) {
      if (el.offsetTop !== top) break;
      c++;
    }
    return Math.max(1, c);
  };

  const rebalanceOne = (grid) => {
    clearBreaks(grid);

    const items = Array.from(grid.querySelectorAll("[data-spon-item]"));
    if (!items.length) return;

    const cols = countCols(items);
    const n = items.length;

    // Don't rebalance if only 1 column or all items fit in one row
    if (cols < 2 || n <= cols) return;

    // Check if last row has only 1 item (orphan)
    const remainder = n % cols;
    
    if (remainder === 1) {
      // We have an orphan - bring down one item to make last row have 2 items
      // This means we insert a break before the second-to-last item
      const br = document.createElement("div");
      br.setAttribute("data-spon-break", "true");
      br.className = "spon-break";

      const secondToLast = items[n - 2];
      if (secondToLast) {
        grid.insertBefore(br, secondToLast);
      }
    }
  };

  const runAll = () => {
    for (const grid of grids()) {
      requestAnimationFrame(() =>
        requestAnimationFrame(() => rebalanceOne(grid))
      );
    }
  };

  runAll();
  window.addEventListener("load", runAll, { once: true });
  window.addEventListener("resize", runAll);
  document.addEventListener("astro:page-load", runAll);

  const ro = new ResizeObserver(runAll);
  grids().forEach((g) => ro.observe(g));
})();
</script>

<style>
.spon-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1.5rem;
  margin-top: 2rem;
}

.spon-item {
  flex: 0 1 auto;
  width: var(--item-width, 200px);
  height: var(--item-height, 120px);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 0.75rem;
  box-sizing: border-box;
}

.spon-break {
  flex-basis: 100%;
  height: 0;
  margin: 0;
  padding: 0;
}

.spon-link {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  text-decoration: none;
  transition: transform 0.2s ease;
}

.spon-link:hover {
  transform: scale(1.05);
}

.spon-logo {
  width: 100%;
  max-width: var(--max-logo-width, 240px);
  max-height: 100%;
  object-fit: contain;
  display: block;
}

/* Responsive adjustments */
@media (hover: none) {
  .sponsor-item {
    width: calc(var(--item-width, 200px) * 0.5);
    height: calc(var(--item-height, 120px) * 0.5);
  }
.spon-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0rem;
  margin-top: 2rem;
}

}
</style>