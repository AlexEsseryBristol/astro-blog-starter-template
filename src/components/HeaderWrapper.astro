---
import HeaderLink from './HeaderLink.astro';
import { Image } from 'astro:assets';
import Logo from '../assets/logo/ciq_white_blue.webp';

export interface InternalLink {
  label: string;
  href: string;
}

export interface ArchiveLink {
  label: string;
  href: string;
  year?: string;
}

export interface Props {
  internalLinks: InternalLink[];
  archiveLinks: ArchiveLink[];
}
const { internalLinks, archiveLinks } = Astro.props;

const pathname = Astro.url.pathname;
const norm = (p: string) => (p.endsWith('/') && p !== '/' ? p.slice(0, -1) : p);
const path = norm(pathname);

const isExact = (href: string) => norm(href) === path;

// Determine archive active states dynamically
const isArchiveActive = archiveLinks.some(a => isExact(a.href));
const archiveStates = archiveLinks.map(a => ({
  ...a,
  isActive: isExact(a.href),
}));
---
<header class="header" data-header>
  <script is:inline>
    (() => {
      const header = document.querySelector('[data-header]');
      if (!header) return;

      const MOBILE_BP = 1350;
      const COMPACT_SCROLL_Y = 120;

      const apply = () => {
        const isMobile = window.matchMedia(`(max-width: ${MOBILE_BP}px)`).matches;
        const shouldCompact = !isMobile && window.scrollY > COMPACT_SCROLL_Y;
        header.classList.toggle('is-compact', shouldCompact);
      };

      apply();
      requestAnimationFrame(() => header.classList.add('is-ready'));
    })();
  </script>

  <nav class="nav" data-nav>
    <div class="left">
      <div class="internal-links">
        {internalLinks.map(link => (
          <HeaderLink href={link.href}>{link.label}</HeaderLink>
        ))}

        {archiveLinks.length > 0 && (
          <div class="nav-item has-dropdown">
            <span
              class:list={['archive-link', isArchiveActive && 'is-archive-active']}
              tabindex="0"
              role="button"
              aria-haspopup="true"
              aria-expanded="false"
            >
              <span class="navlabel">Archive</span>
              <span class="chev" aria-hidden="true">▾</span>
            </span>

            <div class="dropdown" role="menu" aria-label="Archive menu">
              {archiveStates.map(a => (
                <a
                  class:list={['dropdown-link', a.isActive && 'is-active']}
                  role="menuitem"
                  href={a.href}
                  aria-current={a.isActive ? 'page' : undefined}
                >
                  {a.label}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>

      <button
        class="burger burger--inline"
        type="button"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
        data-burger-inline
      >
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="brand">
      <a href="/" class="logo-link" aria-label="Home">
        <Image src={Logo} alt="CiQ" class="logo" loading="eager" decoding="sync"/>
      </a>
    </div>

    <div class="right desktop-right">
      <a href="/conduct" class="btn">Code of Conduct</a>
      <a href="/contact" class="btn">Contact Us</a>
      <a href="https://x.com/CIQ_event" target="_blank" rel="noopener noreferrer" class="x-link">
        <span class="sr-only">Follow CiQ on X</span>
        <svg viewBox="0 0 1200 1227" aria-hidden="true" width="32" height="32">
          <path fill="currentColor" d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/>
        </svg>
      </a>
    </div>
  </nav>

  <button
    class="burger burger--float"
    type="button"
    aria-label="Open menu"
    aria-expanded="false"
    aria-controls="mobile-menu"
    hidden
    data-burger-float
  >
    <span></span><span></span><span></span>
  </button>

  <div id="mobile-menu" class="mobile-menu" hidden data-menu>
    {internalLinks.map(link => (
      <HeaderLink href={link.href} mobile>{link.label}</HeaderLink>
    ))}

    {archiveLinks.length > 0 && (
      <div class="archive-mobile" aria-label="Archive submenu (mobile)">
        <button
          type="button"
          class:list={['archive-toggle', isArchiveActive && 'is-archive-active']}
          aria-expanded="false"
          aria-controls="archive-sub"
          data-archive-toggle
        >
          <span class="navlabel">Archive</span>
          <span class="chev" aria-hidden="true" data-archive-chevron>▾</span>
        </button>

        <div id="archive-sub" class="archive-sub" hidden data-archive-sub>
          {archiveLinks.map(a => (
            <HeaderLink href={a.href} mobile>{a.label}</HeaderLink>
          ))}
        </div>
      </div>
    )}

    <a href="/conduct" class="btn btn--mobile">Code of Conduct</a>
    <a href="/contact" class="btn btn--mobile">Contact Us</a>

    <a href="https://x.com/CIQ_event" target="_blank" rel="noopener noreferrer" class="mobile-x" aria-label="Follow CiQ on X">
      <svg viewBox="0 0 1200 1227" aria-hidden="true" width="20" height="20" class="x-icon">
        <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z"/>
      </svg>
    </a>
  </div>

  <script>
    const header = document.querySelector('[data-header]');
    const menu = header?.querySelector('[data-menu]');
    const burgerInline = header?.querySelector('[data-burger-inline]');
    const burgerFloat = header?.querySelector('[data-burger-float]');

    const MOBILE_BP = 1100;
    const COMPACT_SCROLL_Y = 120;
    const mobileMq = window.matchMedia(`(max-width: ${MOBILE_BP}px)`);

    if (header && menu && burgerInline && burgerFloat) {
      const archiveToggle = header.querySelector('[data-archive-toggle]');
      const archiveSub = header.querySelector('[data-archive-sub]');
      const archiveChevron = header.querySelector('[data-archive-chevron]');

      const setArchiveExpanded = (expanded) => {
        if (!archiveToggle || !archiveSub) return;
        archiveToggle.setAttribute('aria-expanded', String(expanded));
        if (expanded) archiveSub.removeAttribute('hidden');
        else archiveSub.setAttribute('hidden', '');
        if (archiveChevron) archiveChevron.textContent = expanded ? '▴' : '▾';
      };

      setArchiveExpanded(false);

      const setExpanded = () => {
        const expanded = String(!menu.hasAttribute('hidden'));
        burgerInline.setAttribute('aria-expanded', expanded);
        burgerFloat.setAttribute('aria-expanded', expanded);
      };

      const closeMenu = () => {
        menu.setAttribute('hidden', '');
        if (mobileMq.matches) setArchiveExpanded(false);
        setExpanded();
      };

      const toggleMenu = () => {
        menu.toggleAttribute('hidden');
        setExpanded();
      };

      const applyCompact = () => {
        const shouldCompact = !mobileMq.matches && window.scrollY > COMPACT_SCROLL_Y;
        header.classList.toggle('is-compact', shouldCompact);

        if (shouldCompact) {
          burgerFloat.removeAttribute('hidden');
          closeMenu();
        } else {
          burgerFloat.setAttribute('hidden', '');
        }
      };

      const syncForBreakpoint = () => {
        if (!mobileMq.matches) {
          setArchiveExpanded(false);
          closeMenu();
        }
        applyCompact();
      };

      burgerInline.addEventListener('click', (e) => {
        e.preventDefault();
        toggleMenu();
      });

      burgerFloat.addEventListener('click', (e) => {
        e.preventDefault();
        toggleMenu();
      });

      archiveToggle?.addEventListener('click', (e) => {
        if (!mobileMq.matches) return;
        e.preventDefault();
        const expanded = archiveToggle.getAttribute('aria-expanded') === 'true';
        setArchiveExpanded(!expanded);
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMenu();
      });

      document.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof Node)) return;
        if (!menu.hasAttribute('hidden') && !header.contains(t)) closeMenu();
      });

      window.addEventListener('scroll', applyCompact, { passive: true });
      mobileMq.addEventListener('change', syncForBreakpoint);

      setExpanded();
      syncForBreakpoint();
    }
  </script>

  <style>
    /* ALL your original CSS goes here unchanged */
  </style>
</header>


<style>
.header {
	position: sticky;
	top: 0;
	z-index: 1000;
	margin: 0;
	padding: 0 1em;
	background: hsl(192, 100%, 15%);
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
	color: rgb(var(--white));
}

.nav {
	position: relative;
	display: flex;
	align-items: center;
	justify-content: space-between;
	min-height: 96px;
	transition: none;
}

.header.is-ready .nav {
	transition: opacity 180ms ease, transform 180ms ease;
}

.brand {
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%, -50%);
	display: flex;
	align-items: center;
	pointer-events: none;
}

.logo-link {
	pointer-events: auto;
	display: flex;
	align-items: center;
	padding: 0;
	margin: 0;
	color: inherit;
	text-decoration: none;
}

.logo {
	display: block;
	height: 64px;
	width: auto;
}

.left {
	display: flex;
	align-items: center;
	flex: 1;
	min-width: 0;
}

:root {
	--active-bg: rgba(255, 255, 255, 0.12);
	--active-border: rgba(255, 255, 255, 0.22);
}

.internal-links {
	display: inline-flex;
	align-items: center;
	justify-content: flex-start;
	gap: clamp(0.5rem, 1.2vw, 1rem);
	width: fit-content;
	max-width: none;
}

.internal-links :global(a),
.mobile-menu :global(a) {
	text-decoration: none !important;
}

.archive-link.is-archive-active,
.archive-parent.is-archive-active,
.archive-toggle.is-archive-active {
	background: var(--active-bg) !important;
	border: 1px solid var(--active-border) !important;
	font-weight: inherit !important;
	text-decoration: none !important;
	box-shadow: none !important;
	text-shadow: 1px 0 currentColor;
}

.archive-link:hover,
.archive-link:focus-visible,
.archive-parent:hover,
.archive-parent:focus-visible,
.archive-toggle:hover,
.archive-toggle:focus-visible,
.dropdown-link:hover,
.dropdown-link:focus-visible,
.dropdown-link.is-active:hover,
.dropdown-link.is-active:focus-visible,
.mobile-menu :global(a:not(.btn)):hover,
.mobile-menu :global(a:not(.btn)):focus-visible,
.archive-sub :global(a:hover),
.archive-sub :global(a:focus-visible) {
	color: #00bcae;
	background: rgba(255, 255, 255, 0.08);
}

.dropdown-link.is-active {
	text-decoration: none !important;
	text-shadow: 1px 0 currentColor;
}

.nav-item {
	position: relative;
	display: inline-flex;
	align-items: center;
}

.archive-link {
	position: relative;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding: 0.45rem 0.65rem;
	border-radius: 12px;
	color: inherit;
	text-decoration: none;
	line-height: 1;
	white-space: nowrap;
	border: 1px solid transparent;
	padding-right: 1.55rem;
	cursor: default;
	user-select: none;
}

.archive-link .chev {
	position: absolute;
	right: 0.55rem;
	top: 50%;
	transform: translateY(-50%);
	opacity: 0.9;
	pointer-events: none;
}

.dropdown {
	position: absolute;
	top: calc(100% + 0.4rem);
	left: 50%;
	transform: translateX(-50%);
	min-width: 200px;
	padding: 0.25rem;
	border-radius: 14px;
	background: hsl(192, 100%, 15%);
	border: 1px solid rgba(255, 255, 255, 0.15);
	display: none;
	z-index: 1200;
}

.nav-item.has-dropdown {
	transform: translateX(-0.6rem);
}

.has-dropdown::after {
	content: "";
	position: absolute;
	left: -10px;
	right: -10px;
	top: 100%;
	height: 14px;
}

.has-dropdown:hover .dropdown,
.has-dropdown:focus-within .dropdown {
	display: block;
}

.dropdown-link {
	display: flex;
	align-items: center;
	justify-content: center;
	width: 100%;
	box-sizing: border-box;
	color: inherit;
	text-decoration: none;
	padding: 0.65rem 0.75rem;
	border-radius: 12px;
	white-space: nowrap;
	text-align: center;
}

.desktop-right {
	display: flex;
	align-items: center;
	gap: 0.75rem;
	min-width: 0;
}

.btn {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding: 0.55rem 0.9rem;
	border-radius: 999px;
	background: rgb(var(--white));
	color: hsl(192, 100%, 15%);
	text-decoration: none;
	font-weight: 600;
	line-height: 1;
	border: 1px solid rgba(255, 255, 255, 0.25);
	white-space: nowrap;
}

.btn:hover { background-color: #00bcae; color: white;}

.x-link {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	color: rgb(var(--white));
	text-decoration: none;
	border-radius: 10px;
}

.x-link:hover { color: #00bcae; }

.burger {
	display: none;
	flex-direction: column;
	justify-content: center;
	align-items: center;
	gap: 6px;
	width: 44px;
	height: 44px;
	border-radius: 12px;
	border: 1px solid rgba(255, 255, 255, 0.25);
	background: transparent;
	padding: 0;
	cursor: pointer;
	background: white;
}

.burger span {
	display: block;
	width: 25px;
	height: 4px;
	background: hsl(192, 100%, 15%);
	border-radius: 999px;
}

.burger:hover,
.burger:focus-visible {
	background:#00bcae;
}

.burger:hover span,
.burger:focus-visible span {
	background: white;
}

.mobile-menu {
	position: absolute;
	left: 1em;
	right: 1em;
	top: 100%;
	background: hsl(192, 100%, 15%);
	border: 1px solid rgba(255, 255, 255, 0.15);
	border-radius: 14px;
	padding: 0.5rem;
	display: grid;
	gap: 0.25rem;
	z-index: 1010;
	margin-top: 0.5rem;
	justify-items: center;
	overflow: visible;
}

.mobile-menu :global(a:not(.btn)) {
	display: flex;
	align-items: center;
	justify-content: center;
	width: 100%;
	box-sizing: border-box;
	color: inherit;
	text-decoration: none;
	padding: var(--mobile-row-pad-y,0.75rem) var(--mobile-row-pad-x,0.9rem);
	border-radius: var(--mobile-row-radius,12px);
	line-height: var(--mobile-row-line,1);
	text-align: center;
}

.btn--mobile {
	width: 100%;
	justify-content: center;
	padding: var(--mobile-row-pad-y,0.75rem) var(--mobile-row-pad-x,0rem);
	border-radius: var(--mobile-row-radius,12px);
	line-height: var(--mobile-row-line,1);
}

.btn--mobile--link {
	width: 100%;
	justify-content: center;
	padding: var(--mobile-row-pad-y,0.75rem) var(--mobile-row-pad-x,0rem);
	border-radius: var(--mobile-row-radius,12px);
	line-height: var(--mobile-row-line,1);
	border-color: transparent;
	color: white;
}

.x-icon path { fill: currentColor; }

.archive-popout-item { width: 100%; position: relative; display: none; }

.archive-parent {
	display: grid;
	grid-template-columns: 1fr auto 1fr;
	align-items: center;
	width: 100%;
	box-sizing: border-box;
	color: inherit;
	text-decoration: none;
	padding: 0.5rem 0.75rem;
	border-radius: 10px;
	border: 1px solid transparent;
	user-select: none;
}

.archive-parent .navlabel { grid-column: 2; justify-self: center; }
.archive-parent .chev { grid-column: 3; justify-self: end; opacity: 0.9; }

.archive-link .navlabel {
  font-size: 1.35rem; /* your desired size */
}
.archive-popout-item::after {
	content: "";
	position: absolute;
	top: 0;
	right: -16px;
	width: 16px;
	height: 100%;
}

.archive-popout {
	position: absolute;
	left: calc(100% + 12px);
	top: -6px;
	min-width: 200px;
	padding: 0.5rem;
	border-radius: 14px;
	background: hsl(192, 100%, 15%);
	border: 1px solid rgba(255, 255, 255, 0.15);
	display: none;
	z-index: 1300;
}

.archive-popout-item:hover .archive-popout,
.archive-popout-item:focus-within .archive-popout { display: block; }

.archive-mobile { width: 100%; display: block; }

.archive-toggle {
	display: grid;
	grid-template-columns: 1fr auto 1fr;
	align-items: center;
	width: 100%;
	box-sizing: border-box;
	background: transparent;
	border: 1px solid transparent;
	cursor: pointer;
	color: inherit;
	padding: var(--mobile-row-pad-y,0.75rem) var(--mobile-row-pad-x,0.9rem);
	border-radius: var(--mobile-row-radius,12px);
	font: inherit;
	font-size: 1.35rem;
	line-height: var(--mobile-row-line,1);
	min-height: unset;
}

.archive-toggle .navlabel { grid-column: 2; justify-self: center; }
.archive-toggle .chev { grid-column: 3; justify-self: end; opacity: 0.9; }

.archive-sub {
	position: relative;
	width: 100%;
	display: grid;
	padding: 0rem 0.5rem;
	box-sizing: border-box;
}

.archive-sub :global(a) {
	position: relative;
	width: 100%;
	background: transparent !important;
}

.archive-sub::before {
	content: "";
	position: absolute;
	left: 10px;
	right: 10px;
	top: 0;
	bottom: 0;
	border-left: 1px solid rgba(255, 255, 255, 0.18);
	border-right: 1px solid rgba(255, 255, 255, 0.18);
	border-bottom: 1px solid rgba(255, 255, 255, 0.18);
	border-top: 0;
	border-radius: 0 0 14px 14px;
	pointer-events: none;
}

.archive-sub :global(a:hover::after),
.archive-sub :global(a:focus-visible::after) {
	content: "";
	position: absolute;
	left: 12px;
	right: 12px;
	top: 4px;
	bottom: 4px;
	border-radius: 10px;
	background: rgba(255, 255, 255, 0.08);
	pointer-events: none;
}

@media (max-width: 1350px) {
	.internal-links { display: none; }
	.desktop-right { display: none; }
	.burger--inline { display: inline-flex; }
	.mobile-menu .archive-popout-item { display: none; }
	.mobile-menu .archive-mobile { display: block; }
}

@media (min-width: 1101px) {
	.header.is-compact .mobile-menu .archive-popout-item { display: block; }
	.header.is-compact .mobile-menu .archive-mobile { display: none; }
}

[hidden] { display: none !important; }

.header.is-compact {
	background: transparent;
	box-shadow: none;
	padding: 0;
	pointer-events: auto;
}

.header.is-compact .nav {
	opacity: 0;
	transform: translateY(-8px);
	visibility: hidden;
	pointer-events: auto;
}

.header.is-compact .burger--float {
	display: inline-flex;
	position: fixed;
	top: 14px;
	left: 14px;
	z-index: 1100;
	background: white;
	box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
	pointer-events: auto;
}

.header.is-compact .burger--float:hover{background: #00bcae}

.header.is-compact .mobile-menu {
	position: fixed;
	top: -2px;
	left: 4px;
	right: auto;
	width: min(320px, calc(100vw - 28px));
	z-index: 1090;
	pointer-events: auto;
}

.mobile-x:hover{
	color: #00bcae
}
</style>
