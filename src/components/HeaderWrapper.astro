---
import HeaderLink from './HeaderLink.astro';
import { Image } from 'astro:assets';
import Logo from '../assets/logo/ciq_white_blue.webp';

export interface InternalLink {
  label: string;
  href: string;
}

export interface ArchiveLink {
  label: string;
  href: string;
  year?: string;
}

export interface Props {
  internalLinks: InternalLink[];
  archiveLinks: ArchiveLink[];
}
const { internalLinks, archiveLinks } = Astro.props;

const pathname = Astro.url.pathname;
const norm = (p: string) => (p.endsWith('/') && p !== '/' ? p.slice(0, -1) : p);
const path = norm(pathname);

const isExact = (href: string) => norm(href) === path;

const isArchiveActive = path === '/archive' || path.startsWith('/archive/');
const archiveStates = archiveLinks.map(a => ({
  ...a,
  isActive: isExact(a.href),
}));
---

<header class="header" data-header>
  <script is:inline>
    (() => {
      const header = document.querySelector('[data-header]');
      if (!header) return;

      const MOBILE_BP = 1450;
      const COMPACT_SCROLL_Y = 120;

      const apply = () => {
        const isMobile = window.matchMedia(`(max-width: ${MOBILE_BP}px)`).matches;
        const shouldCompact = !isMobile && window.scrollY > COMPACT_SCROLL_Y;
        header.classList.toggle('is-compact', shouldCompact);
      };

      apply();
      requestAnimationFrame(() => header.classList.add('is-ready'));
    })();
  </script>

  <nav class="nav" data-nav>
    <div class="left">
      <div class="internal-links">
        {internalLinks.map(link => (
          <HeaderLink href={link.href}>{link.label}</HeaderLink>
        ))}

        {archiveLinks.length > 0 && (
          <div class="nav-item has-dropdown">
            <span
              class:list={['archive-link', isArchiveActive && 'is-archive-active']}
              tabindex="0"
              role="button"
              aria-haspopup="true"
              aria-expanded="false"
            >
              <span class="navlabel">Archive</span>
              <span class="chev" aria-hidden="true">▾</span>
            </span>

            <div class="dropdown" role="menu" aria-label="Archive menu">
              {archiveStates.map(a => (
                <a
                  class:list={['dropdown-link', a.isActive && 'is-active']}
                  role="menuitem"
                  href={a.href}
                >
                  {a.label}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>

      <button
        class="burger burger--inline"
        type="button"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
        data-burger-inline
      >
        <span></span><span></span><span></span>
      </button>
    </div>

    <div class="brand">
      <a href="/" class="logo-link" aria-label="Home">
        <Image src={Logo} alt="CiQ" class="logo" loading="eager" decoding="sync"/>
      </a>
    </div>

    <div class="right desktop-right">
      <a href="/conduct" class="btn">Code of Conduct</a>
      <a href="/privacy" class="btn">Privacy Policy</a>
      <a href="/contact" class="btn">Contact Us</a>
    </div>
  </nav>

  <button
    class="burger burger--float"
    type="button"
    aria-label="Open menu"
    aria-expanded="false"
    aria-controls="mobile-menu"
    hidden
    data-burger-float
  >
    <span></span><span></span><span></span>
  </button>

  <div id="mobile-menu" class="mobile-menu" hidden data-menu>
    {internalLinks.map(link => (
      <HeaderLink href={link.href} mobile>{link.label}</HeaderLink>
    ))}

    {archiveLinks.length > 0 && (
      <>
        {/* DESKTOP POPOUT (Matches structure of your first code block) */}
        <div class="archive-popout-item" aria-label="Archive submenu (desktop)">
          <span
            class:list={['archive-parent', isArchiveActive && 'is-archive-active']}
            tabindex="0"
            role="button"
            aria-haspopup="true"
          >
            <span class="navlabel">Archive</span>
            <span class="chev" aria-hidden="true">▸</span>
          </span>

          <div class="archive-popout" role="menu" aria-label="Archive years">
            {archiveStates.map(a => (
              <a
                class:list={['dropdown-link', a.isActive && 'is-active']}
                role="menuitem"
                href={a.href}
              >
                {a.label}
              </a>
            ))}
          </div>
        </div>

        {/* MOBILE ACCORDION (Matches structure of your second code block) */}
        <div class="archive-mobile" aria-label="Archive submenu (mobile)">
          <button
            type="button"
            class:list={['archive-toggle', isArchiveActive && 'is-archive-active']}
            aria-expanded="false"
            aria-controls="archive-sub"
            data-archive-toggle
          >
            <span class="navlabel">Archive</span>
            <span class="chev" aria-hidden="true" data-archive-chevron>▾</span>
          </button>

          <div id="archive-sub" class="archive-sub" hidden data-archive-sub>
            {archiveStates.map(a => (
              <HeaderLink href={a.href} mobile>{a.label}</HeaderLink>
            ))}
          </div>
        </div>
      </>
    )}

    <a href="/conduct" class="btn btn--mobile">Code of Conduct</a>
    <a href="/privacy" class="btn btn--mobile">Privacy Policy</a>
    <a href="/contact" class="btn btn--mobile">Contact Us</a>
  </div>

<script>
  const header = document.querySelector('[data-header]');
  const menu = header?.querySelector('[data-menu]');
  const burgerInline = header?.querySelector('[data-burger-inline]');
  const burgerFloat = header?.querySelector('[data-burger-float]');

  const MOBILE_BP = 1450; // Updated to match your CSS breakpoint
  const COMPACT_SCROLL_Y = 220;
  
  let lastScrollY = window.scrollY;

  if (header && menu && burgerInline && burgerFloat) {
    const archiveToggle = header.querySelector('[data-archive-toggle]');
    const archiveSub = header.querySelector('[data-archive-sub]');
    const archiveChevron = header.querySelector('[data-archive-chevron]');

    if (archiveToggle && archiveSub) {
      archiveToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isExpanded = archiveToggle.getAttribute('aria-expanded') === 'true';
        
        // Toggle the expanded state
        archiveToggle.setAttribute('aria-expanded', !isExpanded ? 'true' : 'false');
        
        // Toggle the hidden attribute on the sub-menu
        if (!isExpanded) {
          archiveSub.removeAttribute('hidden');
          if (archiveChevron) archiveChevron.textContent = '▴'; // Point up when open
        } else {
          archiveSub.setAttribute('hidden', '');
          if (archiveChevron) archiveChevron.textContent = '▾'; // Point down when closed
        }
      });
    }

    const closeMenu = () => {
      if (menu.hasAttribute('hidden')) return;
      menu.setAttribute('hidden', '');
      burgerInline.setAttribute('aria-expanded', "false");
      burgerFloat.setAttribute('aria-expanded', "false");
      // Reset archive if mobile
      if (window.innerWidth <= 1100 && archiveToggle) {
        archiveToggle.setAttribute('aria-expanded', "false");
        archiveSub?.setAttribute('hidden', '');
      }
    };

    const toggleMenu = () => {
      const isHidden = menu.hasAttribute('hidden');
      if (isHidden) menu.removeAttribute('hidden');
      else menu.setAttribute('hidden', '');
      
      const expanded = String(isHidden);
      burgerInline.setAttribute('aria-expanded', expanded);
      burgerFloat.setAttribute('aria-expanded', expanded);
    };

    const handleScroll = () => {
      const currentScroll = window.scrollY;
      const isMobileView = window.innerWidth <= MOBILE_BP;

      // 1. MOBILE BEHAVIOR
      if (isMobileView) {
        // Force header to NOT be compact so it stays visible and clickable
        header.classList.remove('is-compact');
        burgerFloat.setAttribute('hidden', '');
        
        // Only close menu if scrolling DOWN significantly
        if (currentScroll > lastScrollY && currentScroll > 50) {
          closeMenu();
        }
      } 
      
      // 2. DESKTOP BEHAVIOR (Compact/Float Mode)
      else {
        const shouldCompact = currentScroll > COMPACT_SCROLL_Y;
        const wasCompact = header.classList.contains('is-compact');
        
        header.classList.toggle('is-compact', shouldCompact);

        if (shouldCompact) {
          burgerFloat.removeAttribute('hidden');
        } else {
          burgerFloat.setAttribute('hidden', '');
          // If we return to the top, close the menu to prevent styling jump
          if (wasCompact) closeMenu();
        }
      }
      lastScrollY = currentScroll;
    };

    burgerInline.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); toggleMenu(); });
    burgerFloat.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); toggleMenu(); });

    document.addEventListener('click', (e) => {
      if (!menu.hasAttribute('hidden') && !header.contains(e.target)) closeMenu();
    });

    window.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', () => {
      handleScroll(); // Keeps the compact/float logic working

      // If the screen gets wider than the mobile breakpoint (1450px)
      if (window.innerWidth > MOBILE_BP) {
        closeMenu(); // Closes the mobile burger menu
        
        // Also explicitly close the archive accordion if it was left open
        if (archiveToggle) {
          archiveToggle.setAttribute('aria-expanded', "false");
          archiveSub?.setAttribute('hidden', '');
          if (archiveChevron) archiveChevron.textContent = '▾';
        }
      }
    });

    handleScroll();
  }
</script>
</header>

<style>
  /* ALL STYLES EXACTLY FROM YOUR SECOND BLOCK */
  .header {
    position: sticky; top: 0; z-index: 1000; margin: 0; padding: 0 1em;
    background: hsl(192, 100%, 15%); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); color: rgb(var(--white));
  }
  .nav { position: relative; display: flex; align-items: center; justify-content: space-between; min-height: 96px; }
  .header.is-ready .nav { transition: opacity 180ms ease, transform 180ms ease; }
  .brand { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; pointer-events: none; }
  .logo-link { pointer-events: auto; display: flex; align-items: center; padding: 0; margin: 0; color: inherit; text-decoration: none; }
  .logo { display: block; height: clamp(16px,64px,64px); width: auto; object-fit: contain; }
  .left { display: flex; align-items: center; flex: 1; min-width: 0; }
  :root { --active-bg: rgba(255, 255, 255, 0.12); --active-border: rgba(255, 255, 255, 0.22); }
  .internal-links { display: inline-flex; align-items: center; justify-content: flex-start; gap: clamp(0.5rem, 1.2vw, 1rem); width: fit-content; max-width: none; }
  .internal-links :global(a), .mobile-menu :global(a) { text-decoration: none !important; }

  /* Archive States */
    .archive-link.is-archive-active, 
    .archive-parent.is-archive-active, 
    .archive-toggle.is-archive-active,
    .archive-toggle[aria-expanded="true"] {
        background: var(--active-bg) !important; 
        border: 1px solid var(--active-border) !important;
        text-shadow: 1px 0 currentColor;
    }

    .archive-toggle.is-archive-active{color: #00bcae;}

  /* Hover Styles */
  @media (hover: hover){
  .archive-link:hover, .archive-link:focus-visible, .archive-parent:hover, .archive-parent:focus-visible, 
  .archive-toggle:hover, .archive-toggle:focus-visible, .dropdown-link:hover, .dropdown-link:focus-visible, 
  .dropdown-link.is-active:hover, .dropdown-link.is-active:focus-visible, .mobile-menu :global(a:not(.btn)):hover, 
  .mobile-menu :global(a:not(.btn)):focus-visible, .archive-sub :global(a:hover), .archive-sub :global(a:focus-visible) {
    color: #00bcae; background: rgba(255, 255, 255, 0.08);}
    .btn:hover { background: #00bcae; color: white; filter: none; }
    .burger:hover { background: #00bcae; }
  .burger:hover span { background: white; }
  }

    .archive-sub :global(.active),
    .dropdown :global(.active) {
        background: rgba(255, 255, 255, 0.15) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        color: #00bcae !important;
        text-shadow: 1px 0 currentColor;
    }
    .dropdown-link, 
    .archive-sub :global(a) {
        color: white;
        transition: all 0.2s ease;
    }
  .nav-item { position: relative; display: inline-flex; align-items: center; }

  /* Desktop dropdown labels */
  .archive-link { 
    position: relative; display: inline-flex; align-items: center; justify-content: center; 
    padding: 0.45rem 0.65rem; border-radius: 12px; color: inherit; text-decoration: none; 
    line-height: 1; white-space: nowrap; border: 1px solid transparent; padding-right: 1.55rem; cursor: default; user-select: none;
  }
  .archive-link .chev { position: absolute; right: 0.55rem; top: 50%; transform: translateY(-50%); font-size: 0.85em; opacity: 0.9; pointer-events: none; }

  /* Top Nav Dropdown */
  .dropdown {
    position: absolute; top: calc(100% + 0.4rem); left: 50%; transform: translateX(-50%);
    min-width: 200px; padding: 0.25rem; border-radius: 14px; background: hsl(192, 100%, 15%);
    border: 1px solid rgba(255, 255, 255, 0.15); display: none; z-index: 1200;
  }
  .nav-item.has-dropdown { transform: translateX(-0.6rem); }
  .has-dropdown::after { content: ""; position: absolute; left: -10px; right: -10px; top: 100%; height: 14px; }
  .has-dropdown:hover .dropdown, .has-dropdown:focus-within .dropdown { display: block; }
  .dropdown-link { display: flex; align-items: center; justify-content: center; width: 100%; box-sizing: border-box; color: inherit; text-decoration: none; padding: 0.65rem 0.75rem; border-radius: 12px; white-space: nowrap; text-align: center; }

  /* Rights / Buttons */
  .desktop-right { display: flex; align-items: center; gap: 0.75rem; min-width: 0; }
  .btn { 
    display: inline-flex; align-items: center; justify-content: center; padding: 0.55rem 0.9rem 0.45rem; 
    border-radius: 999px; background: rgb(var(--white)); color: hsl(192, 100%, 15%); 
    text-decoration: none; font-weight: 600; line-height: 1; border: 1px solid rgba(255, 255, 255, 0.25); white-space: nowrap;
  }
  .x-link { display: inline-flex; align-items: center; justify-content: center; color: rgb(var(--white)); text-decoration: none; border-radius: 10px; }

  /* Burgers */
  .burger {
    display: none; flex-direction: column; justify-content: center; align-items: center; gap: 6px;
    width: 44px; height: 44px; border-radius: 12px; background: white; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.25);
  }
  .burger span { display: block; width: 25px; height: 4px; background: hsl(192, 100%, 15%); border-radius: 999px; }

  /* Mobile/Compact Menu */
  .mobile-menu {
    position: relative; top: 100%; background: hsl(192, 100%, 15%); 
    display: grid; gap: 0.25rem; z-index: 1010; justify-items: center; overflow: visible; 
  }
  @media (hover: hover){
    .mobile-menu{
        margin-top: 0.9rem;
        margin-left: 0.5rem;
        padding: 0.25rem 0.25rem;
        border-radius: 14px;
    }
  }
  @media (hover: none){
    .mobile-menu{
        position: absolute;
        top: 100%;
        left: -1em !important; 
        right: -1em !important;
        padding: 0.5rem 1.5rem !important;
        box-sizing: border-box;
    }
  }
  .btn--mobile { width: 100%; justify-content: center; padding: 0.75rem 0.9rem; border-radius: 12px; box-sizing: border-box; line-height: 1;}
  .navlabel { font: inherit; font-size: 1.35rem; line-height: 1;}
  .navlabel:active { font: inherit; font-size: 1.35rem; line-height: 1;}

  /* SIDE POPOUT (DESKTOP) logic from block 1 */
  .archive-popout-item { width: 100%; position: relative; display: none; }
  .archive-parent {
    display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
    width: 100%; box-sizing: border-box; color: inherit; padding: 0.5rem 0.75rem;
    border-radius: 10px; border: 1px solid transparent; user-select: none;
  }
  .archive-parent .navlabel { grid-column: 2; justify-self: center; }
  .archive-parent .chev { grid-column: 3; justify-self: end; font-size: 0.85em; opacity: 0.9; }
  .archive-popout-item::after { content: ""; position: absolute; top: 0; right: -16px; width: 16px; height: 100%; }
  .archive-popout {
    position: absolute; left: calc(100% + 12px); top: -6px; min-width: 200px; padding: 0.5rem;
    border-radius: 14px; background: hsl(192, 100%, 15%); border: 1px solid rgba(255, 255, 255, 0.15);
    display: none; z-index: 1300;
  }
  .archive-popout-item:hover .archive-popout { display: block; }

  /* MOBILE ACCORDION logic from block 2 */
  .archive-mobile { width: 100%; display: block; }
  .archive-toggle {
    display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
    width: 100%; box-sizing: border-box; background: transparent; border: 1px solid transparent;
    cursor: pointer; color: inherit; padding: 0.68rem 0.68rem; border-radius: 10px; font: inherit;
  }
  .archive-toggle .navlabel { grid-column: 2; justify-self: center; }
  .archive-toggle .chev { grid-column: 3; justify-self: end; font-size: 0.85em; opacity: 0.9; }
  .archive-sub { position: relative; width: 100%; display: grid; gap: 0.25rem; padding: 0.38rem 1rem 0.38rem; margin-top: 0.08rem; box-sizing: border-box; }
  .archive-sub::before {
    content: ""; position: absolute; left: 10px; right: 10px; top: 0; bottom: 0;
    border: 1px solid rgba(255, 255, 255, 0.18); border-top: 0; border-radius: 0 0 14px 14px; pointer-events: none;
  }

  /* Breakpoint Switching */
  @media (max-width: 1450px) {
    .internal-links, .desktop-right { display: none; }
    .burger--inline { display: inline-flex; }
  }
  @media (min-width: 1101px) {
    .header.is-compact .archive-popout-item { display: block; }
    .header.is-compact .archive-mobile { display: none; }
  }
  @media (max-width: 1100px) {
    .archive-popout-item { display: none !important; }
    .archive-mobile { display: block !important; }
  }

  /* Compact Mode Header Override */
  .header.is-compact { background: transparent; box-shadow: none; padding: 0; pointer-events: none; }
  .header.is-compact .nav { opacity: 0; transform: translateY(-8px); visibility: hidden; pointer-events: none; }
  .header.is-compact .burger--float {
    display: inline-flex; position: fixed; top: 14px; left: 14px; z-index: 1150; pointer-events: auto;
  }
  .header.is-compact .mobile-menu {
    position: fixed; top: -2px; left: 4px; right: auto; width: min(320px, calc(100vw - 28px)); z-index: 1090; pointer-events: auto;
  }

  [hidden] { display: none !important; }
/* Ensure mobile header is always solid and interactive */
@media (hover: none) {
.header {
    pointer-events: auto !important;
    background: hsl(192, 100%, 15%) !important;
    opacity: 1 !important;
}

.nav {
    opacity: 1 !important;
    visibility: visible !important;
    transform: none !important;
    pointer-events: auto !important;
    display: flex !important;
}

.mobile-menu {
    /* Ensure it anchors correctly to the sticky header on mobile */
    position: absolute;
    left: 0.5rem;
    right: 0.5rem;
    width: auto;
}
}
</style>